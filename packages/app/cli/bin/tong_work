#!/bin/bash
set -e

# 检测平台
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

case "$OS" in
  darwin*) OS="darwin" ;;
  linux*) OS="linux" ;;
  mingw*|msys*|cygwin*) OS="windows" ;;
esac

case "$ARCH" in
  x86_64*) ARCH="x64" ;;
  aarch64*|arm64*) ARCH="arm64" ;;
esac

# 查找构建产物
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DIST_DIR="$SCRIPT_DIR/../dist/tong_work-${OS}-${ARCH}"

if [ -d "$DIST_DIR" ]; then
  EXEC_FILE="$DIST_DIR/bin/tong_work"
  if [ -f "$EXEC_FILE" ]; then
    exec "$EXEC_FILE" "$@"
  fi
fi

# 如果没有构建产物，使用 TypeScript 源码运行
echo "No binary found, running from source..."
cd "$SCRIPT_DIR/.."
exec bun run ./src/index.ts "$@"
