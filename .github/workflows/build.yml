name: Build and Release

on:
  push:
    branches: [main, master, dev]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      release:
        description: 'Create release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  BUN_VERSION: '1.3.8'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: |
          cd packages/core
          bun install

      - name: Run typecheck
        run: |
          cd packages/core
          bun run typecheck

      - name: Run tests
        run: |
          cd packages/core
          bun run test

  build:
    name: Build ${{ matrix.target }}
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux x64
          - target: tong_work-linux-x64
            os: ubuntu-latest
            arch: x64
          # Linux ARM64
          - target: tong_work-linux-arm64
            os: ubuntu-latest
            arch: arm64
          # macOS x64
          - target: tong_work-darwin-x64
            os: macos-latest
            arch: x64
          # macOS ARM64 (Apple Silicon)
          - target: tong_work-darwin-arm64
            os: macos-latest
            arch: arm64
          # Windows x64
          - target: tong_work-windows-x64
            os: windows-latest
            arch: x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: |
          cd packages/core
          bun install

      - name: Build TypeScript
        run: |
          cd packages/core
          bun run build

      - name: Build binary
        run: |
          cd packages/core
          bun run scripts/build.ts --single
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: packages/core/dist/${{ matrix.target }}/bin/*
          if-no-files-found: error

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.release == 'true'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create archives
        run: |
          mkdir -p releases
          for dir in artifacts/*/; do
            name=$(basename "$dir")
            if [[ "$name" == *"linux"* ]]; then
              tar -czf "releases/${name}.tar.gz" -C "$dir" .
            else
              cd "$dir" && zip -r "../../releases/${name}.zip" . && cd ../..
            fi
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
