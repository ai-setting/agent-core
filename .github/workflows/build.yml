name: Build and Release

on:
  push:
    branches: [main, master, dev]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      release:
        description: 'Create release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  BUN_VERSION: '1.3.8'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: |
          cd packages/core
          bun install

      - name: Run typecheck
        run: |
          cd packages/core
          bun run typecheck

      - name: Run tests
        run: |
          cd packages/core
          bun run test

  build:
    name: Build ${{ matrix.platform }}
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds (all on ubuntu-latest x64 runner with cross-compilation)
          - os: ubuntu-latest
            platform: linux-arm64
          - os: ubuntu-latest
            platform: linux-x64
          - os: ubuntu-latest
            platform: linux-x64-baseline
            bun-avx2: false
          # macOS builds (both on macos-latest which is ARM64, cross-compiles to x64)
          - os: macos-latest
            platform: darwin-arm64
          - os: macos-latest
            platform: darwin-x64
          # Windows builds (only on windows runner)
          - os: windows-latest
            platform: windows-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        shell: bash
        run: |
          cd packages/core
          bun install

      - name: Build binary
        id: build
        shell: bash
        run: |
          echo "Building ${{ matrix.platform }}..."
          cd packages/core

          # Clean previous builds
          rm -rf dist/

          # Determine target directory name
          TARGET="tong_work-${{ matrix.platform }}"
          echo "Target: $TARGET"

          # Build based on platform capabilities:
          # - Linux: can build all Linux targets (x64, arm64) via cross-compilation
          # - macOS: can build all Darwin targets (arm64, x64) via cross-compilation
          # - Windows: can only build Windows targets
          case "${{ matrix.platform }}" in
            "linux-arm64")
              # Build all Linux targets, then keep only arm64
              bun run build
              ;;
            "linux-x64")
              # Build all Linux targets, then keep only x64
              bun run build
              ;;
            "linux-x64-baseline")
              # Build with baseline flag
              bun run build --baseline
              ;;
            "darwin-arm64"|"darwin-x64")
              # macOS can build all Darwin targets
              bun run build
              ;;
            "windows-x64")
              # Windows can only build Windows targets
              bun run build --single
              ;;
          esac

          # Keep only the target directory, delete others
          if [ -d "dist" ]; then
            cd dist
            echo "Available directories in dist:"
            ls -la
            # Keep only our target, delete everything else
            for dir in */; do
              dir_name=$(basename "$dir")
              if [ "$dir_name" != "$TARGET" ]; then
                echo "Removing unwanted directory: $dir_name"
                rm -rf "$dir_name"
              fi
            done
            cd ..
          fi

          echo "Build completed"
          echo "Final dist contents:"
          ls -laR dist/ 2>/dev/null || echo "No dist directory"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: packages/core/dist/**/bin/
          retention-days: 5

  release:
    name: Package & Upload Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.release == 'true'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create release assets
        run: |
          cd artifacts
          for dir in */; do
            name=$(basename "$dir")
            if [[ "$name" == linux* ]]; then
              tar -czf "${name}.tar.gz" -C "$dir" .
            else
              cd "$dir" && zip -r "../${name}.zip" . && cd ..
            fi
          done

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
