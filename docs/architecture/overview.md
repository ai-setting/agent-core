# 应用架构设计文档 (App Architecture)

## 1. 概述

本文档描述基于 agent-core 框架构建的应用架构，包括 Server、CLI、Desktop 和 Web 四种形态。

**核心设计**: EventBus 事件总线机制，将 agent-core 内部的事件通过 EventBus 发布，各客户端通过 SSE 接收并处理。

## 2. 架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Client Layer                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │
│  │    CLI      │  │   Desktop   │  │    Web      │  │  Other Clients  │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘ │
└─────────┼────────────────┼────────────────┼──────────────────┼──────────┘
          │                │                │                  │
          └────────────────┴───────┬────────┴──────────────────┘
                                   │ SSE (Server-Sent Events)
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Server Layer                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                        HTTP Server                                   │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │ │
│  │  │ REST API     │  │ SSE Endpoint │  │  Session Management API  │  │ │
│  │  │ (CRUD)       │  │ (/events)    │  │  (/sessions, /prompt)    │  │ │
│  │  └──────┬───────┘  └──────┬───────┘  └────────────┬─────────────┘  │ │
│  │         │                 │                       │                 │ │
│  │         └─────────────────┴───────────┬───────────┘                 │ │
│  │                                       │                             │ │
│  │  ┌────────────────────────────────────▼─────────────────────────┐  │ │
│  │  │                      EventBus                                 │  │ │
│  │  │  • 事件发布 (Publish)                                        │  │ │
│  │  │  • 事件订阅 (Subscribe)                                      │  │ │
│  │  │  • 广播到所有 SSE 连接                                       │  │ │
│  │  └────────────────────────────────────┬─────────────────────────┘  │ │
│  └───────────────────────────────────────┼────────────────────────────┘ │
└──────────────────────────────────────────┼──────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Agent-Core Framework                                │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                     BaseEnvironment                                  │ │
│  │                                                                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │ │
│  │  │   Tools     │  │   invoke_llm│  │   Prompts   │  │  Handlers  │ │ │
│  │  └──────┬──────┘  └──────┬──────┘  └─────────────┘  └─────┬──────┘ │ │
│  │         │                │                                 │        │ │
│  │         │                │     onStreamEvent Hook          │        │ │
│  │         │                └────────────────┐                │        │ │
│  │         │                                 │                │        │ │
│  │         │     ┌───────────────────────────▼────────────────┤        │ │
│  │         │     │                                            │        │ │
│  │         │     │  StreamEvent: {                            │        │ │
│  │         │     │    type: 'text' | 'reasoning' |            │        │ │
│  │         │     │          'tool_call' | 'tool_result' |     │        │ │
│  │         │     │          'completed' | 'error' | 'start'   │        │ │
│  │         │     │    content?: string                        │        │ │
│  │         │     │    tool_name?: string                      │        │ │
│  │         │     │    tool_args?: object                      │        │ │
│  │         │     │    tool_result?: object                    │        │ │
│  │         │     │  }                                         │        │ │
│  │         │     │                                            │        │ │
│  │         │     └───────────────────────────┬────────────────┘        │ │
│  │         │                                 │                         │ │
│  │         │                                 ▼                         │ │
│  │  ┌──────▼─────────────────────────────────▼─────────────────────┐  │ │
│  │  │                     EventBus.publish(event)                   │  │ │
│  │  └──────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. 核心设计要点

### 3.1 EventBus

- **职责**: 接收来自 agent-core 的流式事件，广播给所有订阅者
- **实现**: 单例模式，支持全局订阅和按 session 订阅
- **位置**: `app/server/src/eventbus/`

### 3.2 SSE (Server-Sent Events)

- **端点**: `GET /events?sessionId=<optional>`
- **用途**: 向客户端推送实时流式事件
- **优势**: 单向流、自动重连、HTTP 兼容

### 3.3 Client-Server 通信

1. **发送消息**: `POST /sessions/:id/prompt` (异步)
2. **接收响应**: SSE 流式推送
3. **Session 管理**: REST API

## 4. 文档索引

- **整体架构**: [architecture/overview.md](./overview.md) (本文档)
- **Server 设计**: [app/server-design.md](./app/server-design.md)
- **CLI 设计**: [app/cli-design.md](./app/cli-design.md)
- **Desktop 设计**: (待补充)
- **Web 设计**: (待补充)

## 5. 实现优先级

1. **Phase 1**: EventBus + Server HTTP + SSE
2. **Phase 2**: invoke_llm 事件触发
3. **Phase 3**: CLI Client 连接
4. **Phase 4**: Desktop/Web 客户端

---

**注意**: 实现具体功能前，请先阅读对应的设计文档理解设计理念。
